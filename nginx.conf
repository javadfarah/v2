user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
  worker_connections 500;
  multi_accept on;
}

http {

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
  ssl_prefer_server_ciphers on;

  error_log /dev/stdout;

  gzip on;
  # Rate limiting: 10 requests/sec per IP, 20 burst
  limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=10r/s;

  # Connection limiting: max 20 WebSocket connections per IP
  limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

  
  server {
      listen       80;


      listen  [::]:80;


      server_name  hr.sagpaz.sbs abbas.sagpaz.sbs 127.0.0.1 localhost  oh-no-my-abbas.darkube.app;
      access_log /dev/stdout;

      location /test {
        return 200 'gangnam style!';
      }
      location /api/v1/test_api {
          if ($content_type !~ "application/grpc") {
              return 200 '{"status": "ok"}';
              add_header Content-Type application/json;
          }
          grpc_pass grpc://127.0.0.1:10087;
          grpc_set_header Host $host;
          grpc_set_header X-Real-IP $remote_addr;
          grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      }
      location /.well-known/acme-challenge/ {
          return 200 "OK";
          add_header Content-Type text/plain;
      }
      location /api/v1/healthcheck {
        if ($http_upgrade != "websocket") { # Return 404 error when WebSocket upgrading negotiate failed
                    return 200 '{"status": "ok"}';
                    add_header Content-Type application/json;
        }
        proxy_redirect off;
        proxy_pass http://127.0.0.1:10086/socket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        # Show real IP in v2ray access.log
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Rate limiting
        limit_req zone=ws_limit burst=20 nodelay;
        limit_conn conn_limit 20;
      }

      location / {
        resolver  8.8.8.8;
        proxy_pass https://www.mehrnews.com/;
        proxy_set_header Host www.mehrnews.com;
        proxy_ssl_server_name on;
      }

      location = /50x.html {
          root   /usr/share/nginx/html;
      }

  }

server {
      listen 443 default_server;
      listen [::]:443 ;
      server_name hr.sagpaz.sbs abbas.sagpaz.sbs 127.0.0.1 localhost oh-no-my-abbas.darkube.app;
      access_log /dev/stdout;

      # CDN handles SSL, no need for certificates here
      ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;  # Allow old versions as per your CDN handling
      ssl_prefer_server_ciphers on;

      location /test {
        return 200 'gangnam style!';
      }
      location /api/v1/test_api {
          if ($content_type !~ "application/grpc") {
              return 200 '{"status": "ok"}';
              add_header Content-Type application/json;
          }
          grpc_pass grpc://127.0.0.1:10087;
          grpc_set_header Host $host;
          grpc_set_header X-Real-IP $remote_addr;
          grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      }
      location /.well-known/acme-challenge/ {
          return 200 "OK";
          add_header Content-Type text/plain;
      }
      location /api/v1/healthcheck {
        if ($http_upgrade != "websocket") {
                return 200 '{"status": "ok"}';
                add_header Content-Type application/json;
        }
        proxy_redirect off;
        proxy_pass http://127.0.0.1:10086/socket;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Rate limiting
        limit_req zone=ws_limit burst=20 nodelay;
        limit_conn conn_limit 20;
      }

      location / {
        resolver 8.8.8.8;
        proxy_pass https://www.mehrnews.com/;
        proxy_set_header Host www.mehrnews.com;
        proxy_ssl_server_name on;
      }

      location = /50x.html {
        root /usr/share/nginx/html;
      }
  }


}
